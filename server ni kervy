
import React, { useState, useEffect } from 'react';
import {Edit, Trash2, CheckCircle, LayoutGrid, CheckSquare, Trophy } from 'lucide-react';
import axios from 'axios';
import '../styles/tasks.css';

const Tasks = ({ loggedInUser }) => {
Â  const [tasks, setTasks] = useState([]);
Â  const [filter, setFilter] = useState('All');
Â  const [isModalOpen, setIsModalOpen] = useState(false);
Â  const [editingTask, setEditingTask] = useState(null);
Â  
Â  // FIX 1: Default priority must be capitalized to match your DB ENUM
Â  const [formData, setFormData] = useState({ 
Â  Â  title: '', 
Â  Â  description: '', 
Â  Â  priority: 'Low' 
Â  });

Â  useEffect(() => {
Â  Â  fetchTasks();
Â  }, []);

Â  const fetchTasks = async () => {
Â  Â  try {
Â  Â  Â  const res = await axios.get('http://localhost:5000/api/tasks');
Â  Â  Â  if (res.data.success) setTasks(res.data.tasks);
Â  Â  } catch (err) {
Â  Â  Â  console.error("Error fetching tasks", err);
Â  Â  }
Â  };

Â  const handleToggleComplete = async (task) => {
Â  Â  // FIX 2: Status must match your DB ENUM capitalization exactly
Â  Â  const newStatus = task.status === 'Completed' ? 'Pending' : 'Completed';
Â  Â  try {
Â  Â  Â  await axios.put(`http://localhost:5000/api/tasks/${task.id}/status`, { status: newStatus });
Â  Â  Â  fetchTasks(); 
Â  Â  } catch (err) {
Â  Â  Â  console.error("Update failed", err);
Â  Â  }
Â  };

Â  const handleSubmit = async (e) => {
Â  Â  e.preventDefault();
Â  Â  try {
Â  Â  Â  if (editingTask) {
Â  Â  Â  Â  await axios.put(`http://localhost:5000/api/tasks/${editingTask.id}`, formData);
Â  Â  Â  } else {
Â  Â  Â  Â  // FIX 3: Ensure user_id and priority are formatted correctly for MariaDB
Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  title: formData.title,
Â  Â  Â  Â  Â  description: formData.description || null,
Â  Â  Â  Â  Â  priority: formData.priority, // Now correctly capitalized
Â  Â  Â  Â  Â  user_id: loggedInUser?.id || null
Â  Â  Â  Â  };
Â  Â  Â  Â  await axios.post('http://localhost:5000/api/tasks', payload);
Â  Â  Â  }
Â  Â  Â  closeModal();
Â  Â  Â  fetchTasks();
Â  Â  } catch (err) {
Â  Â  Â  console.error("Save Error:", err.response?.data || err);
Â  Â  Â  alert("Error saving task. Check if you are logged in correctly.");
Â  Â  }
Â  };

Â  const closeModal = () => {
Â  Â  setIsModalOpen(false);
Â  Â  setEditingTask(null);
Â  Â  setFormData({ title: '', description: '', priority: 'Low' });
Â  };

Â  const handleDelete = async (id) => {
Â  Â  if (window.confirm("Delete this task?")) {
Â  Â  Â  await axios.delete(`http://localhost:5000/api/tasks/${id}`);
Â  Â  Â  fetchTasks();
Â  Â  }
Â  };

Â  const total = tasks.length;
Â  const completed = tasks.filter(t => t.status === 'Completed').length;
Â  const progressPercent = total > 0 ? Math.round((completed / total) * 100) : 0;

Â  const filteredTasks = tasks.filter(t => filter === 'All' || t.priority === filter);

Â  return (
Â  Â  <div className="tasks-page-container">
Â  Â  Â  {/* ðŸ“Š TOP PROGRESS SECTION */}
Â  Â  Â  <div className="stats-cards-row">
Â  Â  Â  Â  <div className="stat-card-mini">
Â  Â  Â  Â  Â  <div className="stat-icon-bg blue"><LayoutGrid size={20} /></div>
Â  Â  Â  Â  Â  <div className="stat-card-info">
Â  Â  Â  Â  Â  Â  <span className="stat-number">{total}</span>
Â  Â  Â  Â  Â  Â  <span className="stat-label">Total Tasks</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div className="stat-card-mini">
Â  Â  Â  Â  Â  <div className="stat-icon-bg green"><CheckSquare size={20} /></div>
Â  Â  Â  Â  Â  <div className="stat-card-info">
Â  Â  Â  Â  Â  Â  <span className="stat-number">{progressPercent}%</span>
Â  Â  Â  Â  Â  Â  <span className="stat-label">Progress</span>
Â  Â  Â  Â  Â  Â  <div className="mini-progress-bar">
Â  Â  Â  Â  Â  Â  Â  Â <div className="fill" style={{ width: `${progressPercent}%` }}></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div className="stat-card-mini">
Â  Â  Â  Â  Â  <div className="stat-icon-bg purple"><Trophy size={20} /></div>
Â  Â  Â  Â  Â  <div className="stat-card-info">
Â  Â  Â  Â  Â  Â  <span className="stat-number">{completed}</span>
Â  Â  Â  Â  Â  Â  <span className="stat-label">Completed</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div className="tasks-main-content">
Â  Â  Â  Â  <div className="tasks-header">
Â  Â  Â  Â  Â  <h2>All Tasks</h2>
Â  Â  Â  Â  Â  <div className="header-actions">
Â  Â  Â  Â  Â  Â  <div className="filter-pill">
Â  Â  Â  Â  Â  Â  Â  {['All', 'Low', 'Medium', 'High'].map(f => (
Â  Â  Â  Â  Â  Â  Â  Â  <button key={f} className={filter === f ? 'active' : ''} onClick={() => setFilter(f)}>{f}</button>
Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button className="btn-primary" onClick={() => setIsModalOpen(true)}>Add a new Task</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div className="tasks-grid">
Â  Â  Â  Â  Â  {filteredTasks.map(task => (
Â  Â  Â  Â  Â  Â  <div className={`task-card ${task.status === 'Completed' ? 'status-completed' : ''}`} key={task.id}>
Â  Â  Â  Â  Â  Â  Â  <div className="card-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>{task.title}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p>{task.description}</p>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div className="task-footer">
Â  Â  Â  Â  Â  Â  Â  Â  <span className="task-meta">Yesterday</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span className={`priority-label ${task.priority?.toLowerCase()}`}>{task.priority}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <div className="action-icons">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <CheckCircle 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size={18} 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className={`icon-check ${task.status === 'Completed' ? 'checked' : ''}`} 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => handleToggleComplete(task)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  Â  Â  <Edit size={18} className="icon-edit" onClick={() => { setEditingTask(task); setFormData(task); setIsModalOpen(true); }} />
Â  Â  Â  Â  Â  Â  Â  Â  Â  <Trash2 size={18} className="icon-delete" onClick={() => handleDelete(task.id)} />
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  <div className="task-card add-dummy" onClick={() => setIsModalOpen(true)}>
Â  Â  Â  Â  Â  Â  Â <span>+ Add New Task</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  {isModalOpen && (
Â  Â  Â  Â  <div className="modal-overlay">
Â  Â  Â  Â  Â  <div className="modal-body">
Â  Â  Â  Â  Â  Â  <h3>{editingTask ? 'Edit Task' : 'New Task'}</h3>
Â  Â  Â  Â  Â  Â  <form onSubmit={handleSubmit}>
Â  Â  Â  Â  Â  Â  Â  <input 
Â  Â  Â  Â  Â  Â  Â  Â  type="text" 
Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Title" 
Â  Â  Â  Â  Â  Â  Â  Â  value={formData.title} 
Â  Â  Â  Â  Â  Â  Â  Â  onChange={e => setFormData({...formData, title: e.target.value})} 
Â  Â  Â  Â  Â  Â  Â  Â  required 
Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  <textarea 
Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Description" 
Â  Â  Â  Â  Â  Â  Â  Â  value={formData.description} 
Â  Â  Â  Â  Â  Â  Â  Â  onChange={e => setFormData({...formData, description: e.target.value})} 
Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  {/* FIX 4: Options must match DB ENUM exactly */}
Â  Â  Â  Â  Â  Â  Â  <select 
Â  Â  Â  Â  Â  Â  Â  Â  value={formData.priority} 
Â  Â  Â  Â  Â  Â  Â  Â  onChange={e => setFormData({...formData, priority: e.target.value})}
Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Low">Low</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Medium">Medium</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="High">High</option>
Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  <div className="form-actions">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onClick={closeModal}>Cancel</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" className="btn-save">Save</button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  )}
Â  Â  </div>
Â  );
};

export default Tasks;
